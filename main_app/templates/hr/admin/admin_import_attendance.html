{% extends 'hr/admin/admin_base.html' %}
{% block title %}Add Attendance | HR Admin {% endblock %}
{% block content %}
{% include 'hr/admin/modals/add_attend.html' %}
<main class="p-6 space-y-6">

  <!-- Page Header with Add Attendance Button -->
  <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
    <h1 class="text-2xl font-semibold text-blue-400">Import Attendance Records</h1>
    <button id="openAddAttendanceModal"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 transition">
      <span class="material-symbols-outlined">person_add</span> Add Attendance
    </button>
  </header>

  <!-- Upload Form -->
  <div class="bg-gray-800 rounded-2xl p-6 shadow border border-gray-700 max-w-lg mx-auto">
    <form method="post" enctype="multipart/form-data" class="flex flex-col gap-4">
      <div class="flex flex-col gap-2">
        <label for="file" class="text-gray-400 font-medium">Choose Excel File (.xls or .xlsx)</label>
        <input type="file" name="file" id="file" accept=".xlsx,.xls"
               class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400"/>
      </div>
      <button type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 justify-center transition">
        <span class="material-symbols-outlined">upload</span> Upload
      </button>
    </form>
  </div>

  <!-- Preview Table -->
  {% if preview %}
  <div class="bg-gray-800 rounded-2xl shadow border border-gray-700 p-4 overflow-x-auto">
    <h2 class="text-lg font-semibold text-blue-400 mb-4 text-center">Preview Attendance Records</h2>
    <form method="post" action="{{ url_for('hr_admin.confirm_import_attendance') }}">
      <table class="min-w-full divide-y divide-gray-700 table-auto text-gray-200">
        <thead class="bg-gray-900">
          <tr>
            <th class="px-3 py-2 text-left text-gray-400">ID</th>
            <th class="px-3 py-2 text-left text-gray-400">Name</th>
            <th class="px-3 py-2 text-left text-gray-400">Department</th>
            <th class="px-3 py-2 text-left text-gray-400">Day</th>
            <th class="px-3 py-2 text-left text-gray-400">Time In</th>
            <th class="px-3 py-2 text-left text-gray-400">Time Out</th>
            <th class="px-3 py-2 text-center text-gray-400">Matched</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-700">
          {% for row in preview %}
          <tr class="hover:bg-gray-700 transition {{ 'bg-red-900 bg-opacity-50' if not row['Matched'] }}">
            <td class="px-3 py-2 whitespace-nowrap">{{ row['Employee ID'] }}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{ row['Name'] }}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{ row['Department'] }}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{ row['Day'] }}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{ row['Time In'] }}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{ row['Time Out'] }}</td>
            <td class="px-3 py-2 text-center">
              {% if row['Matched'] %}
                  <span class="material-symbols-outlined text-green-500">check_circle</span>
              {% else %}
                  <span class="material-symbols-outlined text-red-500">cancel</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="flex justify-end mt-4">
        <button type="submit"
                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl flex items-center gap-2 transition">
          <span class="material-symbols-outlined">data_check</span> Confirm Import
        </button>
      </div>
    </form>
  </div>
  {% endif %}

</main>

<!-- Modal Scripts -->
<script>
  // Manual Attendance Modal
  const openModalBtn = document.getElementById('openAddAttendanceModal');
  const modal = document.getElementById('manualAttendanceModal'); // make sure the include has id="manualAttendanceModal"
  const closeModalBtn = document.getElementById('closeManualAttendanceModal');
  const cancelBtn = document.getElementById('cancelManualAttendance');

  openModalBtn.addEventListener('click', () => modal.classList.remove('hidden'));
  closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));
  cancelBtn.addEventListener('click', () => modal.classList.add('hidden'));
</script>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        Swal.fire({
          icon: "{{ 'success' if category == 'success' else 'error' if category == 'danger' else 'info' }}",
          title: "{{ category|capitalize }}",
          html: "{{ message|safe }}",
          confirmButtonColor: '#3085d6',
        });
      {% endfor %}
    {% endif %}
  {% endwith %}
});
</script>
{% endblock %}
