{% extends 'hr/admin/admin_base.html' %}
{% block title %}Users | HR Admin{% endblock %}

{% block content %}
{% include 'hr/admin/modals/edit_user.html' %}

<main class="p-4 md:p-6 space-y-6">

  <!-- Page Header -->
  <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
    <h1 class="text-2xl font-semibold text-blue-400 flex items-center gap-2">
      <i class="fa-solid fa-users text-3xl"></i>
      Users Record
    </h1>
  </header>

  <!-- Filters & Search -->
  <form id="filterForm" method="get" action="{{ url_for('hr_admin.view_users') }}"
        class="flex flex-col md:flex-row gap-4 items-start md:items-end bg-gray-800 p-4 rounded-2xl shadow border border-gray-700">

    <!-- Role Filter -->
    <div class="flex flex-col gap-2 w-full md:w-40">
      <label for="role" class="text-gray-400 text-sm">Role</label>
      <select id="role" name="role"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm">
        <option value="">All Roles</option>
        <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
        <option value="employee" {% if role_filter == 'employee' %}selected{% endif %}>Employee</option>
        <option value="dept_head" {% if role_filter == 'dept_head' %}selected{% endif %}>Department Head</option>
        <option value="officer" {% if role_filter == 'officer' %}selected{% endif %}>HR Officer</option>
        <option value="staff" {% if role_filter == 'staff' %}selected{% endif %}>Payroll Staff</option>
      </select>
    </div>

    <!-- Status Filter -->
    <div class="flex flex-col gap-2 w-full md:w-32">
      <label for="status" class="text-gray-400 text-sm">Status</label>
      <select id="status" name="status"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm">
        <option value="">All Status</option>
        <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
        <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Inactive</option>
      </select>
    </div>

    <!-- Search -->
    <div class="flex flex-col flex-1 gap-2 w-full">
      <label for="search" class="text-gray-400 text-sm">Search</label>
      <input type="text" name="search" value="{{ search }}"
             placeholder="Search by name or email..."
             class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm"/>
    </div>

    <!-- Search Button -->
    <div class="flex w-full md:w-auto mt-2 md:mt-0">
      <button type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 w-full md:w-auto justify-center transition text-sm">
          <i class="fa-solid fa-user-search text-lg"></i>
        <span class="hidden sm:inline">Search</span>
      </button>
    </div>
  </form>

  <!-- Users Table -->
  <div class="overflow-x-auto bg-gray-800 rounded-2xl shadow border border-gray-700 mt-4">
    <table class="min-w-full divide-y divide-gray-700 text-sm md:text-base">
      <thead class="bg-gray-900">
        <tr>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Full Name</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Email</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Role</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Last Login</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Status</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-700">
        {% for user in users.items %}
        <tr class="hover:bg-gray-700 transition">
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ user.get_full_name() }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ user.email }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ user.role.capitalize() or '-' }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">
            {{ user.last_login.strftime('%Y-%m-%d') if user.last_login else '-' }}
          </td>
          <td class="px-2 sm:px-4 py-2">
            <span class="px-2 py-1 rounded-xl text-sm font-medium
                {% if user.active %}text-green-600{% else %}text-red-600{% endif %}">
              {{ 'Active' if user.active else 'Inactive' }}
            </span>
          </td>
          <td class="px-2 sm:px-4 py-2">
            <a href="javascript:void(0);"
              class="edit-user-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-xl text-sm flex items-center gap-1 transition w-full sm:w-auto justify-center"
              data-url="{{ url_for('hr_admin.edit_user', user_id=user.id) }}">
              <i class="fa-solid fa-pen-to-square text-sm"></i>
              <span>Edit</span>
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="px-4 py-3 text-center text-gray-400">No users found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-4 mt-4 text-gray-400 items-center">
    {% if users.has_prev %}
      <a href="{{ url_for('hr_admin.view_users', page=users.prev_num, search=search, role=role_filter, status=status_filter) }}"
         class="px-4 py-2 bg-gray-700 rounded-xl hover:bg-gray-600 transition text-sm">Previous</a>
    {% endif %}
    <span class="px-4 py-2 text-sm">Page {{ users.page }} of {{ users.pages }}</span>
    {% if users.has_next %}
      <a href="{{ url_for('hr_admin.view_users', page=users.next_num, search=search, role=role_filter, status=status_filter) }}"
         class="px-4 py-2 bg-gray-700 rounded-xl hover:bg-gray-600 transition text-sm">Next</a>
    {% endif %}
  </div>

</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // Auto-submit filters
  const filterForm = document.getElementById('filterForm');
  ['role','status'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', () => filterForm.submit());
  });

  // Edit User Modal
  const editModal = document.getElementById("editUserModal");
  const closeBtn = document.getElementById("closeEditUserModal");
  const cancelBtn = document.getElementById("cancelEditUserModal");
  const editForm = document.getElementById("editUserFormModal");

  document.querySelectorAll(".edit-user-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const url = btn.dataset.url;
      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Failed to fetch user data");
        const data = await res.json();

        editForm.action = url;
        editForm.querySelector('[name="email"]').value = data.email || '';
        editForm.querySelector('[name="first_name"]').value = data.first_name || '';
        editForm.querySelector('[name="last_name"]').value = data.last_name || '';
        editForm.querySelector('[name="role"]').value = data.role || '';
        editForm.querySelector('[name="status"]').value = data.active ? "1" : "0";

        editModal.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Failed to fetch user data", "error");
      }
    });
  });

  [closeBtn, cancelBtn].forEach(btn => btn?.addEventListener("click", () => editModal.classList.add("hidden")));

  editForm?.addEventListener("submit", e => {
    e.preventDefault();
    const _form = e.target;

    Swal.fire({
      title: "Are you sure?",
      text: "Do you want to update this user?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, update!"
    }).then(result => {
      if (result.isConfirmed) _form.submit();
    });
  });
});
</script>
{% endblock %}
