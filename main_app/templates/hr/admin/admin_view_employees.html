{% extends 'hr/admin/admin_base.html' %}
{% block title %}Employees | HR Admin{% endblock %}

{% block content %}
{% include 'hr/admin/modals/add_employee.html' %}
{% include 'hr/admin/modals/edit_employee.html' %}

<main class="p-4 md:p-6 space-y-6">

  <!-- Page Header -->
  <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
    <h1 class="text-2xl font-semibold text-blue-400 flex items-center gap-2">
      <i class="fa-solid fa-id-badge text-3xl"></i>
      Employee Records
    </h1>
    <div class="flex gap-2 flex-wrap">
      <button id="openAddEmployeeModal"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl flex items-center gap-2 transition">
        <i class="fa-solid fa-user-plus"></i>
        <span class="hidden sm:inline">Add Employee</span>
      </button>

      <a href="{{ url_for('hr_admin.view_archived_employees') }}"
        class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-xl flex items-center gap-2 transition">
        <i class="fa-solid fa-trash-alt"></i>
        <span class="hidden sm:inline">View Archive</span>
      </a>

      <a href="{{ url_for('hr_admin.export_employees_excel') }}"
        class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">
        <i class="fa-solid fa-file-arrow-down text-lg"></i>
        <span class="hidden sm:inline">Export Excel</span>
      </a>
      <a href="javascript:void(0);" id="openMoaModal"
        class="flex items-center gap-2 bg-purple-600 text-white px-4 py-2 rounded-xl hover:bg-purple-700 transition">
        <i class="fa-solid fa-file-alt text-lg"></i>
        <span class="hidden sm:inline">Generate MOA</span>
      </a>

    </div>
  </header>

  <!-- Search + Filters -->
  <form method="get" action="{{ url_for('hr_admin.view_employees') }}"
        class="flex flex-col md:flex-row gap-4 items-start md:items-end bg-gray-800 p-4 rounded-2xl shadow border border-gray-700"
        id="employeeFilterForm">

    <!-- Department Filter -->
    <div class="flex flex-col gap-2 w-full md:w-auto flex-1">
      <label for="departmentSelect" class="text-gray-400">Department</label>
      <select name="department_id" id="departmentSelect"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="">All Departments</option>
        {% for dept in departments %}
        <option value="{{ dept.id }}" {% if dept.id|string == selected_department %}selected{% endif %}>
          {{ dept.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Employment Type Filter -->
    <div class="flex flex-col gap-2 w-full md:w-auto flex-1">
      <label for="employmentTypeSelect" class="text-gray-400">Employment Type</label>
      <select name="employment_type_id" id="employmentTypeSelect"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="">All Employment Types</option>
        {% for etype in employment_types %}
        <option value="{{ etype.id }}" {% if etype.id|string == selected_employment_type %}selected{% endif %}>
          {{ etype.name }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- Search Input -->
    <div class="flex flex-col gap-2 w-full md:flex-1">
      <label for="search" class="text-gray-400">Search</label>
      <input type="text" name="search" value="{{ search }}"
             placeholder="Search employees..."
             class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400"/>
    </div>

    <div class="flex w-full md:w-auto">
      <button type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 w-full md:w-auto justify-center transition">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span class="hidden sm:inline">Search</span>
      </button>
    </div>

  </form>

  <!-- Employee Table -->
  <div class="overflow-x-auto bg-gray-800 rounded-2xl shadow border border-gray-700">
    <table class="min-w-full divide-y divide-gray-700 text-sm md:text-base">
      <thead class="bg-gray-900">
        <tr>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">ID</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Full Name</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Department</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Position</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Date Hired</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Status</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-700">
        {% for employee in employees.items %}
        <tr class="hover:bg-gray-700 transition">
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ employee.employee_id }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ employee.get_full_name() }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ employee.department.name if employee.department else '-' }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ employee.position.name if employee.position else '-' }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ employee.date_hired.strftime('%Y-%m-%d') if employee.date_hired else '-' }}</td>
          <td class="px-2 sm:px-4 py-2">
            <span class="px-2 py-1 rounded-xl text-sm font-medium
              {% if employee.status == 'Active' %}
                text-green-500
              {% elif employee.status == 'Retired' %}
                text-gray-400
              {% elif employee.status == 'Resigned' %}
                text-yellow-500
              {% elif employee.status == 'Fired' %}
                text-red-600
              {% else %}
                text-gray-300
              {% endif %}
            ">
              {{ employee.status }}
            </span>
          </td>
          <td class="px-2 sm:px-4 py-2">
            <div class="flex gap-2"> <!-- flex container for row layout -->
              <a href="javascript:void(0);"
                class="edit-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-xl text-sm flex items-center gap-1 transition justify-center"
                data-url="{{ url_for('hr_admin.edit_employee', employee_id=employee.id) }}"
                data-employee-id="{{ employee.id }}">
                <i class="fa-solid fa-pen-to-square text-sm"></i>
                <span class="hidden sm:inline">Edit | View</span>
              </a>

              <a href="javascript:void(0);"
                class="archive-btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-xl text-sm flex items-center gap-1 transition justify-center"
                data-url="{{ url_for('hr_admin.archive_employee', employee_id=employee.id) }}">
                <i class="fa-solid fa-archive text-sm"></i>
                <span class="hidden sm:inline">Archive</span>
              </a>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="px-4 py-3 text-center text-gray-400">No employees found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-4 mt-4 text-gray-400 items-center">
    {% if employees.has_prev %}
    <a href="{{ url_for('hr_admin.view_employees', page=employees.prev_num, search=search, department_id=selected_department, employment_type_id=selected_employment_type) }}"
       class="px-4 py-2 bg-gray-700 rounded-xl hover:bg-gray-600 transition">Previous</a>
    {% endif %}

    <span class="px-4 py-2">{{ employees.page }} of {{ employees.pages }}</span>

    {% if employees.has_next %}
    <a href="{{ url_for('hr_admin.view_employees', page=employees.next_num, search=search, department_id=selected_department, employment_type_id=selected_employment_type) }}"
       class="px-4 py-2 bg-gray-700 rounded-xl hover:bg-gray-600 transition">Next</a>
    {% endif %}
  </div>

</main>
  <!-- Generate MOA Modal -->
  <div id="moaModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-md border border-gray-700 shadow-lg space-y-4">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xl font-semibold text-blue-400">Generate MOA</h2>
        <button id="closeMoaModal" class="text-gray-400 hover:text-gray-200">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <form id="moaForm" method="POST" action="#">
        <label class="text-gray-300">Select Employment Type</label>
        <select name="employment_type_id" id="employmentTypeSelectMoa"
                class="bg-gray-700 text-gray-200 w-full rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-400" required>
          <option value="">Select Type</option>
          {% for etype in employment_types %}
            <option value="{{ etype.id }}">{{ etype.name }}</option>
          {% endfor %}
        </select>

        <div class="flex justify-end gap-2 mt-4">
          <button type="button" id="cancelMoaBtn"
                  class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-xl transition">
            Cancel
          </button>
          <button type="submit"
                  class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl transition">
            Generate
          </button>
        </div>
      </form>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // ------------------ Filters Auto-submit ------------------
  const filterForm = document.getElementById("employeeFilterForm");
  ["departmentSelect","employmentTypeSelect"].forEach(id => {
    document.getElementById(id)?.addEventListener("change", () => filterForm?.submit());
  });

  // ------------------ Add Employee Modal ------------------
  const addModal = document.getElementById("addEmployeeModal");
  const openAddBtn = document.getElementById("openAddEmployeeModal");
  const closeAddBtn = document.getElementById("closeAddEmployeeModal");

  openAddBtn?.addEventListener("click", () => addModal?.classList.remove("hidden"));
  closeAddBtn?.addEventListener("click", () => addModal?.classList.add("hidden"));

  // Multi-step Add Modal Logic
  const steps = document.querySelectorAll(".step");
  let currentStep = 0;
  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");
  const submitBtn = document.getElementById("submitBtn");
  const addForm = document.getElementById("employeeForm");
  const previewContainer = document.getElementById("previewContainer");

  function showStep(n) {
    steps.forEach((s) => s.classList.add("hidden"));
    steps[n]?.classList.remove("hidden");
    prevBtn.style.display = n === 0 ? "none" : "inline-block";
    nextBtn.style.display = n === steps.length - 1 ? "none" : "inline-block";
    submitBtn.style.display = n === steps.length - 1 ? "inline-block" : "none";
    if (n === steps.length - 1) populatePreview();
  }

  function populatePreview() {
    previewContainer.innerHTML = "";
    const addressFields = ["street_address","barangay","municipality","province","postal_code"];
    addForm.querySelectorAll("input, select").forEach(input => {
      if(addressFields.includes(input.name)) return;
      let label = input.previousElementSibling?.innerText || input.name;
      let value = input.tagName === "SELECT" ? input.options[input.selectedIndex]?.text : input.value;
      previewContainer.innerHTML += `<div><p class="font-semibold text-gray-400">${label}</p><p>${value}</p></div>`;
    });
    const street = addForm.querySelector('[name="street_address"]').value;
    const barangay = addForm.querySelector('[name="barangay"]').value;
    const municipality = addForm.querySelector('[name="municipality"]').value;
    const province = addForm.querySelector('[name="province"]').value;
    const postal = addForm.querySelector('[name="postal_code"]').value;
    const fullAddress = [street, barangay, municipality, province, postal].filter(p => p).join(", ");
    previewContainer.innerHTML += `<div><p class="font-semibold text-gray-400">Full Address</p><p>${fullAddress}</p></div>`;
  }

  nextBtn?.addEventListener("click", () => {
    const currentInputs = steps[currentStep].querySelectorAll("input[required], select[required]");
    for (let input of currentInputs) {
      if (!input.value.trim()) {
        Swal.fire({ title: "Missing Field", text: `Please fill ${input.previousElementSibling.innerText}`, icon: "error" });
        return;
      }
    }
    currentStep++;
    showStep(currentStep);
  });

  prevBtn?.addEventListener("click", () => {
    currentStep--;
    showStep(currentStep);
  });

  showStep(currentStep);

  const salaryInput = document.getElementById("salaryInput");
  const employmentTypeSelectModal = addModal?.querySelector('select[name="employment_type_id"]');
  employmentTypeSelectModal?.addEventListener("change", function () {
    const text = this.options[this.selectedIndex]?.text.toLowerCase();
    if (text.includes("casual")) salaryInput.placeholder = "Enter daily rate with leave credits";
    else if (text.includes("regular")) salaryInput.placeholder = "Enter monthly salary with leave credits";
    else if (text.includes("part")) salaryInput.placeholder = "Enter per hour rate";
    else if (text.includes("jo")) salaryInput.placeholder = "Enter daily rate";
    else salaryInput.placeholder = "Enter salary";
  });

  addForm?.addEventListener("submit", function (e) {
    e.preventDefault();
    const _form = this;
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, add employee!"
    }).then(result => {
      if (result.isConfirmed) _form.submit();
    });
  });

  // ------------------ Edit Employee Modal ------------------
  const editModal = document.getElementById("editEmployeeModal");
  const closeEditBtn = document.getElementById("closeEditEmployeeModal");
  const cancelEditBtn = document.getElementById("cancelEditEmployeeModal");

  closeEditBtn?.addEventListener("click", () => editModal?.classList.add("hidden"));
  cancelEditBtn?.addEventListener("click", () => editModal?.classList.add("hidden"));

  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const url = btn.dataset.url;
      const employeeId = btn.dataset.employeeId;

      try {
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Network response was not ok");
        const data = await res.json();

        const form = editModal.querySelector("form");
        form.action = url;

        [
          "first_name","middle_name","last_name","email","phone","gender",
          "marital_status","emergency_contact","department_id","position_id",
          "employment_type_id","salary","date_of_birth","date_hired",
          "street_address","barangay","municipality","province","postal_code"
        ].forEach(field => {
          const input = form.querySelector(`[name="${field}"]`);
          if (input) input.value = data[field] || "";
        });

       const statusSelect = form.querySelector(`[name="status"]`);
      if (statusSelect) statusSelect.value = data.status || "Active";


        // Export Service Record
        const exportBtn = document.getElementById('exportServiceRecordBtn');
        if (exportBtn) {
          exportBtn.href = `/hr/admin/employees/${employeeId}/service_record`;
          exportBtn.target = "_blank";
        }

        // COE Export Button
        const coeBtn = document.getElementById("coeExportBtn");
        if (coeBtn) {
          coeBtn.href = `/hr/admin/employee/${employeeId}/generate-coe`;
          coeBtn.target = "_blank";
        }

        editModal.classList.remove("hidden");
      } catch (err) {
        console.error(err);
        Swal.fire("Error", "Failed to fetch employee data", "error");
      }
    });
  });

  const editForm = editModal?.querySelector("form");
  editForm?.addEventListener("submit", function (e) {
    e.preventDefault();
    const _form = this;
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, update employee!"
    }).then(result => {
      if (result.isConfirmed) _form.submit();
    });
  });

});

// ------------------ Archive Employee ------------------
document.querySelectorAll(".archive-btn").forEach(btn => {
  btn.addEventListener("click", async () => {
    const url = btn.dataset.url;

    Swal.fire({
      title: "Are you sure?",
      text: "This will archive the employee!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, archive!"
    }).then(async (result) => {
      if (result.isConfirmed) {
        try {
          const res = await fetch(url, {
            method: "POST",
            headers: {
              "X-Requested-With": "XMLHttpRequest",
              "Content-Type": "application/json"
            }
          });

          if (!res.ok) throw new Error("Failed to archive employee");

          Swal.fire("Archived!", "Employee has been archived.", "success")
            .then(() => location.reload());
        } catch (err) {
          console.error(err);
          Swal.fire("Error", "Failed to archive employee.", "error");
        }
      }
    });
  });
});

// ------------------ Generate MOA (All Employees) ------------------
document.addEventListener("DOMContentLoaded", () => {
  const moaModal = document.getElementById("moaModal");
  const openMoaBtn = document.getElementById("openMoaModal");
  const closeMoaBtn = document.getElementById("closeMoaModal");
  const cancelMoaBtn = document.getElementById("cancelMoaBtn");
  const moaForm = document.getElementById("moaForm");

  openMoaBtn?.addEventListener("click", () => {
    moaModal.classList.remove("hidden");
    moaModal.classList.add("flex");
  });

  [closeMoaBtn, cancelMoaBtn].forEach(btn => {
    btn?.addEventListener("click", () => {
      moaModal.classList.add("hidden");
      moaModal.classList.remove("flex");
    });
  });

  moaForm?.addEventListener("submit", (e) => {
    e.preventDefault();
    const typeId = document.getElementById("employmentTypeSelectMoa").value;
    if (!typeId) {
      Swal.fire("Missing", "Please select an employment type first.", "warning");
      return;
    }

    // Option 1: Immediately redirect without waiting SweetAlert
    window.location.href = `/hr/admin/generate_moa_all/${typeId}`;
  });
});

</script>

{% endblock %}
