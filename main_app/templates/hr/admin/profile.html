{% extends 'hr/admin/admin_base.html' %}
{% block title %}Employee Profile{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto p-6 bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 rounded-2xl shadow-lg text-slate-100">
  <div class="flex items-center gap-6">
    <!-- Avatar -->
    <div class="w-28 h-28 rounded-full bg-cover bg-center ring-4 ring-slate-700 overflow-hidden flex-shrink-0" style="background-image: url('{{ url_for('static', filename=employee.photo) if employee and employee.photo else url_for('static', filename='img/default-avatar.png') }}')"></div>

    <!-- Name & actions -->
    <div class="flex-1">
      <h1 class="text-2xl font-semibold">{{ employee.get_full_name() if employee else "No name" }}</h1>
      <p class="text-sm text-slate-300">
        {{ employee.position.name if employee and employee.position else 'Position not assigned' }} â€¢ 
        {{ employee.department.name if employee and employee.department else 'No department' }}
      </p>

      <div class="mt-4 flex flex-wrap gap-3">
        <button id="editProfileBtn" class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl shadow-md transition">
          <i class="fa-solid fa-user-pen"></i>
          Edit Profile
        </button>
      </div>
    </div>

    <!-- Quick stats -->
    <div class="text-right">
      <p class="text-sm text-slate-300">Employee ID</p>
      <p class="font-semibold text-lg">{{ employee.employee_id if employee else '-' }}</p>
    </div>
  </div>

  <hr class="my-6 border-slate-700">

  <!-- Details grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="space-y-4">
      <div class="p-4 bg-slate-800 rounded-xl shadow-inner">
        <h3 class="text-sm text-slate-300">Personal Information</h3>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
          <div><span class="text-slate-400">Full name</span><div class="font-medium">{{ employee.get_full_name() if employee else '-' }}</div></div>
          <div><span class="text-slate-400">Birthdate</span><div class="font-medium">{{ employee.date_of_birth.strftime('%B %d, %Y') if employee and employee.date_of_birth else '-' }}</div></div>
          <div><span class="text-slate-400">Age</span><div class="font-medium">{{ age if age else '-' }}</div></div>
          <div><span class="text-slate-400">Gender</span><div class="font-medium">{{ employee.gender if employee else '-' }}</div></div>
          <div><span class="text-slate-400">Civil Status</span><div class="font-medium">{{ employee.marital_status if employee else '-' }}</div></div>
          <div><span class="text-slate-400">Working Years</span><div class="font-medium">{{ working_duration if working_duration else '-' }} years</div></div>
        </div>
      </div>

      <div class="p-4 bg-slate-800 rounded-xl shadow-inner">
        <h3 class="text-sm text-slate-300">Contact</h3>
        <div class="mt-3 space-y-2 text-sm">
          <div><span class="text-slate-400">Mobile</span><div class="font-medium">{{ employee.phone if employee else '-' }}</div></div>
          <div><span class="text-slate-400">Email</span><div class="font-medium">{{ employee.email if employee else '-' }}</div></div>
          <div><span class="text-slate-400">Address</span><div class="font-medium">{{ employee.get_full_address() if employee else '-' }}</div></div>
        </div>
      </div>
    </div>

    <div class="space-y-4">
      <div class="p-4 bg-slate-800 rounded-xl shadow-inner">
        <h3 class="text-sm text-slate-300">Employment Details</h3>
        <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
          <div><span class="text-slate-400">Department</span><div class="font-medium">{{ employee.department.name if employee and employee.department else '-' }}</div></div>
          <div><span class="text-slate-400">Position</span><div class="font-medium">{{ employee.position.name if employee and employee.position else '-' }}</div></div>
          <div><span class="text-slate-400">Employment Type</span><div class="font-medium">{{ employee.employment_type.name if employee and employee.employment_type else '-' }}</div></div>
          <div><span class="text-slate-400">Date Hired</span><div class="font-medium">{{ employee.date_hired.strftime('%B %d, %Y') if employee and employee.date_hired else '-' }}</div></div>
          <div><span class="text-slate-400">Salary</span><div class="font-medium">{{ "{:,.2f}".format(employee.salary) if employee and employee.salary else '-' }}</div></div>
        </div>
      </div>

      <div class="p-4 bg-slate-800 rounded-xl shadow-inner">
        <h3 class="text-sm text-slate-300">Emergency Contact</h3>
        <div class="mt-3 space-y-2 text-sm">
          <div><span class="text-slate-400">Name</span><div class="font-medium">{{ employee.emergency_contact if employee else '-' }}</div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Edit Profile Modal -->
<div id="editProfileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-slate-900 rounded-2xl w-full max-w-md p-6 relative">
    <h2 class="text-xl font-semibold text-white mb-4"><i class="fa-solid fa-user-pen"></i> Edit Profile</h2>
    <button id="closeModalBtn" class="absolute top-4 right-4 text-slate-400 hover:text-white">&times;</button>

    <form id="editProfileForm" class="space-y-4">
      <div>
        <label class="block text-slate-300 text-sm">Current Password</label>
        <input type="password" name="current_password" required class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800 text-white border border-slate-600" placeholder="Enter current password">
      </div>
      <div>
        <label class="block text-slate-300 text-sm">Email</label>
        <input type="email" name="email" value="{{ user.email if user else '' }}" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800 text-white border border-slate-600">
      </div>
      <div>
        <label class="block text-slate-300 text-sm">New Password</label>
        <input type="password" name="new_password" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800 text-white border border-slate-600">
      </div>
      <div>
        <label class="block text-slate-300 text-sm">Confirm Password</label>
        <input type="password" name="confirm_password" class="w-full mt-1 px-3 py-2 rounded-lg bg-slate-800 text-white border border-slate-600">
      </div>
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl w-full flex items-center justify-center gap-2">
        <i class="fa-solid fa-floppy-disk"></i> Save Changes
      </button>
    </form>
  </div>
</div>

<script>
  const modal = document.getElementById('editProfileModal');
  const editBtn = document.getElementById('editProfileBtn');
  const closeBtn = document.getElementById('closeModalBtn');

  editBtn.addEventListener('click', () => modal.classList.remove('hidden'));
  closeBtn.addEventListener('click', () => modal.classList.add('hidden'));

  document.getElementById('editProfileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());

    const result = await Swal.fire({
      title: 'Confirm Update',
      text: 'Are you sure you want to update your profile?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonColor: '#2563EB',
      cancelButtonColor: '#6B7280',
      confirmButtonText: 'Yes, update it!'
    });

    if (result.isConfirmed) {
      try {
        const response = await fetch('{{ url_for('hr_admin.edit_profile') }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data)
        });

        const resData = await response.json();

        if(resData.status === 'success') {
          Swal.fire('Updated!', resData.message, 'success').then(() => location.reload());
        } else {
          Swal.fire('Error', resData.message, 'error');
        }
      } catch (err) {
        Swal.fire('Error', 'Something went wrong. Please try again.', 'error');
      }
    }
  });
</script>
{% endblock %}
