{% extends 'hr/admin/admin_base.html' %}
{% block title %}Attendance | HR Admin{% endblock %}

{% block content %}
{% include 'hr/admin/modals/edit_attend.html' %}

<main class="p-4 md:p-6 space-y-6">
  <!-- Page Header -->
  <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
    <h1 class="text-2xl font-semibold text-blue-400 flex items-center gap-2">
      <i class="fa-regular fa-calendar text-3xl"></i>
      Attendance Records
    </h1>
  </header>

  <!-- Filters -->
  <form method="get" action="{{ url_for('hr_admin.attendance') }}" id="attendanceFilterForm"
        class="flex flex-col md:flex-row md:flex-wrap gap-4 items-start md:items-end bg-gray-800 p-4 rounded-2xl shadow border border-gray-700">

    <!-- Date Filters -->
    <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/4">
      <label for="start_date" class="text-gray-400">Start Date</label>
      <input type="date" id="start_date" name="start_date" value="{{ start_date }}"
             class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400"/>
    </div>
    <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/4">
      <label for="end_date" class="text-gray-400">End Date</label>
      <input type="date" id="end_date" name="end_date" value="{{ end_date }}"
             class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400"/>
    </div>

    <!-- Employee Filter -->
    <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/4">
      <label for="employee" class="text-gray-400">Employee</label>
      <select id="employee" name="employee"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="">All Employees</option>
        {% for emp in employees %}
          <option value="{{ emp.id }}" {% if employee_filter == emp.id|string %}selected{% endif %}>
            {{ emp.get_full_name() }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Department Filter -->
    <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/4">
      <label for="department" class="text-gray-400">Department</label>
      <select id="department" name="department"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="">All Departments</option>
        {% for dept in departments %}
          <option value="{{ dept.id }}" {% if department_filter == dept.id|string %}selected{% endif %}>
            {{ dept.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Status Filter -->
    <div class="flex flex-col gap-2 w-full sm:w-1/2 md:w-1/4">
      <label for="status" class="text-gray-400">Status</label>
      <select id="status" name="status"
              class="bg-gray-700 text-gray-200 rounded-lg px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-blue-400">
        <option value="">All Status</option>
        <option value="Present" {% if status_filter == 'Present' %}selected{% endif %}>Present</option>
        <option value="Late" {% if status_filter == 'Late' %}selected{% endif %}>Late</option>
        <option value="Absent" {% if status_filter == 'Absent' %}selected{% endif %}>Absent</option>
      </select>
    </div>

    <!-- Submit Button -->
    <div class="flex w-full sm:w-auto md:self-end">
      <button type="submit"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 w-full sm:w-auto justify-center transition">
        <i class="fa-solid fa-magnifying-glass"></i> Filter
      </button>
    </div>
  </form>

  <!-- Attendance Table -->
  <div class="overflow-x-auto bg-gray-800 rounded-2xl shadow border border-gray-700">
    <table class="min-w-full divide-y divide-gray-700 text-sm md:text-base table-auto">
      <thead class="bg-gray-900">
        <tr>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Employee</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Department</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Date</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Time In</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Time Out</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Working Hours</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Status</th>
          <th class="px-2 sm:px-4 py-3 text-left text-gray-400">Actions</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-700">
        {% for attendance in attendances.items %}
        <tr class="hover:bg-gray-700 transition">
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ attendance.employee.get_full_name() }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ attendance.employee.department.name if attendance.employee.department else '-' }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ attendance.date }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ attendance.time_in or '-' }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">{{ attendance.time_out or '-' }}</td>
          <td class="px-2 sm:px-4 py-2 text-gray-200 whitespace-nowrap">
            {% if attendance.status == 'Absent' %}<span class="text-gray-400">N/A</span>
            {% else %}{{ '%.2f'|format(attendance.working_hours) }}{% endif %}
          </td>
          <td class="px-2 sm:px-4 py-2">
            {% if attendance.status == 'Late' %}
              <span class="px-2 py-1 text-orange-600 font-semibold text-sm">Late</span>
            {% elif attendance.status == 'Present' %}
              <span class="px-2 py-1 text-green-600 font-semibold text-sm">Present</span>
            {% elif attendance.status == 'Absent' %}
              <span class="px-2 py-1 text-red-600 font-semibold text-sm">Absent</span>
            {% else %}
              <span class="px-2 py-1 text-gray-400 font-semibold text-sm">{{ attendance.status }}</span>
            {% endif %}
          </td>
          <td class="px-2 sm:px-4 py-2">
            <a href="javascript:void(0);"
               class="edit-attendance-btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded-xl text-sm flex items-center gap-1 transition justify-center"
               data-url="{{ url_for('hr_admin.edit_attendance', attendance_id=attendance.id) }}">
              <i class="fa-solid fa-pen-to-square text-sm"></i>
              <span class="hidden sm:inline">Edit</span>
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="8" class="px-4 py-3 text-center text-gray-400">No attendance records found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="flex flex-col sm:flex-row justify-center gap-2 sm:gap-4 mt-4 text-gray-400 items-center">
    {% if attendances.has_prev %}
      <a href="{{ url_for('hr_admin.attendance', page=attendances.prev_num, start_date=start_date, end_date=end_date, employee=employee_filter, department=department_filter) }}"
         class="px-4 py-2 bg-gray-700 rounded-xl hover:bg-gray-600 transition">Previous</a>
    {% endif %}

    <span class="px-4 py-2">Page {{ attendances.page }} of {{ attendances.pages }}</span>

    {% if attendances.has_next %}
      <a href="{{ url_for('hr_admin.attendance', page=attendances.next_num, start_date=start_date, end_date=end_date, employee=employee_filter, department=department_filter) }}"
         class="px-4 py-2 bg-gray-700 rounded-xl hover:bg-gray-600 transition">Next</a>
    {% endif %}
  </div>

</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  // Auto-submit filters
  const filterForm = document.getElementById("attendanceFilterForm");
  ["employee","department","status"].forEach(id => {
    const el = document.getElementById(id);
    if(el) el.addEventListener("change", () => filterForm.submit());
  });

  // Edit Attendance Modal
  const editModal = document.getElementById("editAttendanceModal");
  const closeBtn = document.getElementById("closeEditAttendanceModal");
  const cancelBtn = document.getElementById("cancelEditAttendance");
  const editForm = document.getElementById("editAttendanceForm");

  closeBtn?.addEventListener("click", () => editModal?.classList.add("hidden"));
  cancelBtn?.addEventListener("click", () => editModal?.classList.add("hidden"));

  document.querySelectorAll(".edit-attendance-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const url = btn.dataset.url;
      try {
        const res = await fetch(url, { headers: {"Accept":"application/json"} });
        if(!res.ok) throw new Error("Failed to fetch attendance data");
        const data = await res.json();

        editForm.action = url;
        ["attendance_id","date","time_in","time_out","modal_status","remarks"].forEach(field => {
          const input = editForm.querySelector(`#${field}`);
          if(input) input.value = data[field] || "";
        });

        editModal.classList.remove("hidden");
      } catch(err) {
        console.error(err);
        Swal.fire("Error","Failed to fetch attendance data","error");
      }
    });
  });

  // Submit with confirmation
  editForm?.addEventListener("submit", function(e){
    e.preventDefault();
    const _form = this;
    Swal.fire({
      title: "Are you sure?",
      text: "You won't be able to revert this!",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#3085d6",
      cancelButtonColor: "#d33",
      confirmButtonText: "Yes, save changes!"
    }).then(result => {
      if(result.isConfirmed) _form.submit();
    });
  });
});
</script>
{% endblock %}