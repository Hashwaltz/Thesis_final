{% extends 'hr/admin/admin_base.html' %}
{% block title %}Department - {{ department.name }}{% endblock %}

{% block content %}
<!-- Include Edit Modal -->
{% include 'hr/admin/modals/edit_dept.html' %}

<main class="p-6 space-y-6 text-white">

  <!-- Header with Dept Name and Edit Button -->
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <h1 class="text-2xl font-bold flex items-center gap-2">
      <i class="fa-solid fa-building-columns text-blue-400 text-3xl"></i>
      {{ department.name }}
    </h1>
    <div class="flex gap-2">
      <a href="{{ url_for('hr_admin.view_departments') }}"
         class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl flex items-center gap-1">
        <i class="fa-solid fa-arrow-left text-sm"></i> Back
      </a>
      <!-- Open Modal Button -->
      <button id="openEditDepartmentModal"
         class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl flex items-center gap-1">
        <i class="fa-solid fa-pen-to-square text-sm"></i> Edit Details
      </button>
    </div>
  </div>

  <!-- Department Description -->
  <section class="bg-gray-800 p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-semibold mb-2 flex items-center gap-2">
      <i class="fa-solid fa-file-lines text-blue-400"></i> Description
    </h2>
    <p class="text-gray-300">{{ department.description or 'No description provided.' }}</p>
  </section>

  <!-- Department Head -->
  <section class="bg-gray-800 p-6 rounded-2xl shadow-lg">
    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
      <i class="fa-solid fa-id-badge text-blue-400"></i> Department Head
    </h2>
    {% if head %}
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 bg-gray-900 p-4 rounded-xl shadow-md">
      <div>
        <p class="text-lg font-medium">{{ head.get_full_name() }}</p>
        <p class="text-gray-400 text-sm">{{ head.email }}</p>
      </div>
    </div>
    {% else %}
      <p class="text-gray-400 italic">No head assigned.</p>
    {% endif %}
  </section>

  <!-- Employees Table -->
  <section class="bg-gray-800 p-6 rounded-2xl shadow-lg overflow-x-auto">
    <h2 class="text-xl font-semibold mb-4 flex items-center gap-2">
      <i class="fa-solid fa-users text-blue-400"></i> Employees
    </h2>
    {% if employees %}
    <table class="w-full text-left text-gray-100">
      <thead>
        <tr class="border-b border-gray-700">
          <th class="py-2 px-4">Name</th>
          <th class="py-2 px-4">Position</th>
          <th class="py-2 px-4">Email</th>
        </tr>
      </thead>
      <tbody>
        {% for emp in employees %}
        <tr class="border-b border-gray-700 hover:bg-gray-700 transition">
          <td class="py-2 px-4 font-medium">{{ emp.get_full_name() }}</td>
          <td class="py-2 px-4">{{ emp.position.name or 'Position N/A' }}</td>
          <td class="py-2 px-4">{{ emp.email }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
      <p class="text-gray-400 italic">No employees in this department.</p>
    {% endif %}
  </section>

</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Open & Close Modal
  const editModal = document.getElementById('editDepartmentModal');
  const openBtn = document.getElementById('openEditDepartmentModal');
  const closeBtn = document.getElementById('closeEditDepartmentModal');
  const cancelBtn = document.getElementById('cancelEditDepartment');

  openBtn.addEventListener('click', () => editModal.classList.remove('hidden'));
  closeBtn.addEventListener('click', () => editModal.classList.add('hidden'));
  cancelBtn.addEventListener('click', () => editModal.classList.add('hidden'));

  // Submit Form with SweetAlert2 Confirmation
  document.getElementById("editDepartmentForm").addEventListener("submit", function(e){
    e.preventDefault(); 

    Swal.fire({
      title: 'Are you sure?',
      text: "Do you want to update this department?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, update!'
    }).then((result) => {
      if (result.isConfirmed) {
        const formData = new FormData(this);
        fetch(this.action, {
          method: 'POST',
          body: formData,
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(data => {
          if(data.status === "success"){
            Swal.fire('Updated!', data.message, 'success').then(() => {
              window.location.reload(); // reload to update department details
            });
          } else {
            Swal.fire('Error!', data.message, 'error');
          }
        })
        .catch(() => {
          Swal.fire('Error!', 'Something went wrong.', 'error');
        });
      }
    });
  });
</script>
{% endblock %}
