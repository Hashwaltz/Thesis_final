{% extends 'payroll/staff/staff_base.html' %}
{% block title %}Staff-Employee Payrolls{% endblock %}

{% block content %}
<main class="content-wrap">
  <header class="content-head">
    <h1><b>Employee Payrolls</b></h1>
  </header>

  <div class="table-container">
    <div class="centered-container">

      <!-- Search and Filters -->
      <div class="searching" style="margin-bottom: 15px;">
        <form method="get" action="{{ url_for('payroll_staff.view_payrolls') }}" class="search-form">
          <div class="fields" style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">

            <!-- Search Bar -->
            <div class="input-field">
              <input type="text" name="search" value="{{ search }}" placeholder="Search payroll details." />
              <button type="submit">Search</button>  
            </div>

            <!-- Department Filter -->
            <div class="input-field">
              <select name="department_id" onchange="this.form.submit()">
                <option value="">All Departments</option>
                {% for dept in departments %}
                  <option value="{{ dept.id }}" {% if dept.id == selected_department %}selected{% endif %}>
                    {{ dept.name }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Payroll Period Filter -->
            <div class="input-field">
              <select name="pay_period_id" onchange="this.form.submit()">
                <option value="">All Periods</option>
                {% for period in payroll_periods %}
                  <option value="{{ period.id }}" {% if selected_pay_period and period.id == selected_pay_period.id %}selected{% endif %}>
                    {{ period.period_name }} ({{ period.start_date.strftime('%Y-%m-%d') }} - {{ period.end_date.strftime('%Y-%m-%d') }})
                  </option>
                {% endfor %}
              </select>
            </div>

          </div>
        </form>
      </div>

      <!-- Generate All Payslips and Export Excel Buttons -->
      <div style="margin-bottom: 15px; text-align: left; display: flex; gap: 10px; flex-wrap: wrap;">

        <!-- Generate All Payslips -->
        <form 
          id="generateAllPayslipsForm"
          action="" 
          method="POST"
        >
          <button 
            type="button" 
            id="generateAllPayslipsBtn"
            class="btn btn-success"
            style="background-color: #198754; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;"
          >
            <span class="material-symbols-outlined" style="vertical-align: middle;">receipt_long</span>
            <span style="vertical-align: middle;">Generate All Payslips</span>
          </button>
        </form>

        <!-- Export to Excel -->
        <a 
          href="{{ url_for('payroll_staff.export_payroll_excel', search=search, department_id=selected_department, pay_period_id=selected_pay_period.id if selected_pay_period else '') }}" 
          class="btn btn-primary" 
          style="background-color: #0d6efd; color: white; border: none; padding: 8px 12px; border-radius: 6px; text-decoration: none; display: flex; align-items: center;"
        >
          <span class="material-symbols-outlined" style="vertical-align: middle; margin-right: 4px;">file_download</span>
          <span style="vertical-align: middle;">Export to Excel</span>
        </a>

      </div>

      <!-- Payroll Table -->
      <table class="responsive-table" style="margin-top: 10px;">
        <caption><b>Payroll Records</b></caption>
        <thead>
          <tr>
            <th>Employee Name</th>
            <th>Department</th>
            <th>Basic Salary</th>
            <th>Gross Pay</th>
            <th>Total Deductions</th>
            <th>Net Pay</th>
            <th>Payroll Period</th>
          </tr>
        </thead>
        <tbody>
          {% for payroll in payrolls.items %}
          <tr>
            <td data-label="Employee Name">{{ payroll.employee.first_name }} {{ payroll.employee.last_name }}</td>
            <td data-label="Department">{{ payroll.employee.department.name if payroll.employee.department else '-' }}</td>
            <td data-label="Hourly Salary">₱ {{ "{:,.2f}".format(payroll.basic_salary or 0) }}</td>
            <td data-label="Gross Pay">₱ {{ "{:,.2f}".format((payroll.net_pay or 0) + payroll.total_deductions_calc()) }}</td>
            <td data-label="Deductions">₱ {{ "{:,.2f}".format(payroll.total_deductions_calc()) }}</td>
            <td data-label="Net Pay"><b>₱ {{ "{:,.2f}".format(payroll.net_pay or 0) }}</b></td>
            <td data-label="Payroll Period">
              {{ payroll.pay_period_start.strftime('%Y-%m-%d') }} - {{ payroll.pay_period_end.strftime('%Y-%m-%d') }}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10">No payroll records found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination">
        {% if payrolls.has_prev %}
          <a href="{{ url_for('payroll_staff.view_payrolls', page=payrolls.prev_num, search=search, department_id=selected_department, pay_period_id=selected_pay_period.id if selected_pay_period else '') }}">Previous</a>
        {% endif %}
        Page {{ payrolls.page }} of {{ payrolls.pages }}
        {% if payrolls.has_next %}
          <a href="{{ url_for('payroll_staff.view_payrolls', page=payrolls.next_num, search=search, department_id=selected_department, pay_period_id=selected_pay_period.id if selected_pay_period else '') }}">Next</a>
        {% endif %}
      </div>

    </div>
  </div>
</main>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
document.getElementById("generateAllPayslipsBtn").addEventListener("click", function() {
  Swal.fire({
    title: 'Generate All Payslips?',
    text: "This will generate payslips for all employees in this payroll period.",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#198754',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Yes, generate',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      document.getElementById("generateAllPayslipsForm").submit();
    }
  });
});
</script>
{% endblock %}
