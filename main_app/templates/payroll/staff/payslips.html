{% extends 'payroll/staff/staff_base.html' %}
{% block title %}Payroll Staff - Payslips{% endblock %}

{% block content %}
<main class="content-wrap">
  <header class="content-head">
    <h1><b>Payslip Management</b></h1>
  </header>

  <div class="table-container">
    <div class="centered-container">

      <!-- ðŸ” Search Form -->
      <div class="searching" style="margin-bottom: 15px;">
        <form method="get" action="{{ url_for('payroll_staff.view_payslips') }}" class="search-form">
          <div style="display: flex; align-items: center; gap: 10px;">
            <input 
              type="text" 
              name="search" 
              value="{{ search or '' }}" 
              placeholder="Search employee name or payslip number..."
              style="width: 280px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;"
            />
            <button 
              type="submit" 
              style="background-color: #3d6ef7; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer;">
              Search
            </button>
          </div>
        </form>
      </div>

      <!-- ðŸ§­ Filters -->
      <div class="filters" style="margin-bottom: 20px; display: flex; justify-content: flex-start; gap: 10px;">
        <form method="get" action="{{ url_for('payroll_staff.view_payslips') }}" id="filterForm" style="display: flex; gap: 10px;">

          <!-- Department Filter -->
          <select name="department_id" onchange="this.form.submit()" style="height: 42px; padding: 0 10px; border: 1px solid #ccc; border-radius: 6px;">
            <option value="">All Departments</option>
            {% if departments %}
              {% for dept in departments %}
                <option value="{{ dept.id }}" {% if dept.id == selected_department %}selected{% endif %}>{{ dept.name }}</option>
              {% endfor %}
            {% else %}
              <option disabled>No departments found</option>
            {% endif %}
          </select>

          <!-- Status Filter -->
          <select name="status" onchange="this.form.submit()" style="height: 42px; padding: 0 10px; border: 1px solid #ccc; border-radius: 6px;">
            <option value="">All Status</option>
            <option value="Not Claimed" {% if selected_status == "Not Claimed" %}selected{% endif %}>Not Claimed</option>
            <option value="Claimed" {% if selected_status == "Claimed" %}selected{% endif %}>Claimed</option>
          </select>

          <!-- Payroll Period Filter -->
          <select name="period_id" onchange="this.form.submit()" style="height: 42px; padding: 0 10px; border: 1px solid #ccc; border-radius: 6px;">
            <option value="">All Periods</option>
            {% for period in payroll_periods %}
              <option value="{{ period.id }}" {% if period.id == selected_period %}selected{% endif %}>
                {{ period.start_date.strftime('%Y-%m-%d') }} to {{ period.end_date.strftime('%Y-%m-%d') }}
              </option>
            {% endfor %}
          </select>

        </form>
      </div>

      <!-- ðŸ§¾ Generate Payslips -->
      <div style="margin-bottom: 15px; text-align: left;">
        <button 
          type="button" 
          id="generatePayslipsByPeriodBtn"
          style="background-color: #198754; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer;">
          <span class="material-symbols-outlined" style="vertical-align: middle;">receipt_long</span>
          <span style="vertical-align: middle;">Generate Payslips by Period</span>
        </button>
      </div>

      <!-- ðŸ“‹ Payslip Table -->
      <table class="responsive-table">
        <caption><b>Payslip Records</b></caption>
        <thead>
          <tr>
            <th>Payslip No.</th>
            <th>Employee</th>
            <th>Department</th>
            <th>Period</th>
            <th>Net Pay</th>
            <th>Generated</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for p in payslips.items %}
          <tr data-payslip-id="{{ p.id }}">
            <td data-label="Payslip No.">{{ p.payslip_number }}</td>
            <td data-label="Employee">{{ p.employee.first_name }} {{ p.employee.last_name }}</td>
            <td data-label="Department">{{ p.employee.department.name if p.employee.department else '-' }}</td>
            <td data-label="Period">{{ p.pay_period_start }} - {{ p.pay_period_end }}</td>
            <td data-label="Net Pay"><b>â‚± {{ "{:,.2f}".format(p.net_pay) }}</b></td>
            <td data-label="Generated">{{ p.generated_at.strftime('%Y-%m-%d') }}</td>

            <td data-label="Status">
              {% if p.status == 'Generated' %}
                <span class="status-badge" style="background-color: #ffc107; color: black; padding: 4px 8px; border-radius: 5px;">Not Claimed</span>
              {% elif p.status == 'Distributed' %}
                <span class="status-badge" style="background-color: #28a745; color: white; padding: 4px 8px; border-radius: 5px;">Claimed</span>
              {% endif %}
            </td>

            <td data-label="Actions" class="action-cell">
              {% if p.status == 'Generated' %}
                <button 
                  type="button" 
                  class="btn-action distribute-btn" 
                  data-url="{{ url_for('payroll_staff.distribute_payslip', payslip_id=p.id) }}"
                  style="background-color: #28a745; color: white;">
                  Mark as Claimed
                </button>
              {% else %}
                <button class="btn-action claimed-btn" style="background-color: gray; color: white;" disabled>Claimed</button>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="10" class="text-muted">No payslips found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- ðŸ“„ Pagination -->
      <div class="pagination">
        {% if payslips.has_prev %}
          <a href="{{ url_for('payroll_staff.view_payslips', page=payslips.prev_num, search=search, department_id=selected_department, status=selected_status, period_id=selected_period) }}">Previous</a>
        {% endif %}
        Page {{ payslips.page }} of {{ payslips.pages }}
        {% if payslips.has_next %}
          <a href="{{ url_for('payroll_staff.view_payslips', page=payslips.next_num, search=search, department_id=selected_department, status=selected_status, period_id=selected_period) }}">Next</a>
        {% endif %}
      </div>
    </div>
  </div>
</main>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ðŸ”„ Generate Payslips by Period
document.getElementById("generatePayslipsByPeriodBtn").addEventListener("click", function() {
  Swal.fire({
    title: 'Generate Payslips?',
    text: "Youâ€™ll be redirected to select a payroll period to generate payslips for.",
    icon: 'question',
    showCancelButton: true,
    confirmButtonColor: '#198754',
    cancelButtonColor: '#d33',
    confirmButtonText: 'Continue',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = "{{ url_for('payroll_staff.generate_payslips_by_period') }}";
    }
  });
});

// âœ… Mark as Claimed (AJAX + Live UI Update)
document.querySelectorAll('.distribute-btn').forEach(button => {
  button.addEventListener('click', function () {
    const payslipRow = this.closest('tr');
    const url = this.getAttribute('data-url');

    Swal.fire({
      title: 'Mark Payslip as Claimed?',
      text: 'This will mark the payslip as claimed by the employee.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, mark it',
      cancelButtonText: 'Cancel'
    }).then((result) => {
      if (result.isConfirmed) {
        fetch(url, { method: 'POST' })
          .then(response => {
            if (response.redirected) {
              return { success: true }; 
            }
            return response.json().catch(() => ({}));
          })
          .then(() => {
            const btn = payslipRow.querySelector('.btn-action');
            btn.textContent = 'Claimed';
            btn.style.backgroundColor = 'gray';
            btn.disabled = true;
            btn.classList.add('claimed-btn');

            const badge = payslipRow.querySelector('.status-badge');
            badge.textContent = 'Claimed';
            badge.style.backgroundColor = '#28a745';
            badge.style.color = 'white';

            Swal.fire({
              title: 'Payslip Claimed!',
              text: 'Marked successfully.',
              icon: 'success',
              timer: 1500,
              showConfirmButton: false
            });
          });
      }
    });
  });
});
</script>
{% endblock %}
