{% extends 'payroll/admin/payroll_admin_base.html' %}
{% block title %}Payroll Admin - Regular Payroll{% endblock %}

{% block content %}
<section class="p-6 space-y-6 text-gray-200">

  <!-- ===== HEADER ===== -->
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold text-emerald-400">
      Regular Payroll
    </h1>
  </div>

  <!-- ===== PAYROLL PERIOD SELECT ===== -->
  <div class="bg-gray-800 p-5 rounded-2xl border border-gray-700 max-w-sm">
    <label class="block text-gray-300 mb-1">Payroll Period</label>
    <select
      id="period"
      onchange="loadWorkedDays()"
      class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-gray-700 text-gray-200 focus:ring-2 focus:ring-emerald-500 outline-none"
    >
      <option value="">Select Period</option>
      {% for p in payroll_periods %}
        <option
          value="{{ p.id }}"
          data-start="{{ p.start_date }}"
          data-end="{{ p.end_date }}"
        >
          {{ p.start_date }} – {{ p.end_date }}
        </option>
      {% endfor %}
    </select>
  </div>

  <!-- ===== REGULAR PAYROLL TABLE ===== -->
  <div class="overflow-x-auto bg-gray-800 rounded-2xl border border-gray-700">
    <table class="min-w-full divide-y divide-gray-700 text-sm">
      <thead class="bg-gray-900">
        <tr>
          <th class="px-6 py-3 text-left text-gray-400">Employee</th>
          <th class="px-6 py-3 text-left text-gray-400">Monthly Salary</th>
          <th class="px-6 py-3 text-left text-gray-400">Allowance</th>
          <th class="px-6 py-3 text-left text-gray-400">Worked Days</th>
          <th class="px-6 py-3 text-left text-gray-400">SSS</th>
          <th class="px-6 py-3 text-left text-gray-400">PhilHealth</th>
          <th class="px-6 py-3 text-left text-gray-400">Pag-IBIG</th>
          <th class="px-6 py-3 text-left text-gray-400">Tax</th>
          <th class="px-6 py-3 text-left text-gray-400">Other Deductions</th>
          <th class="px-6 py-3 text-left text-gray-400">Net Pay</th>
          <th class="px-6 py-3 text-left text-gray-400">Action</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-700">
        {% for emp in employees %}
        <tr
          class="hover:bg-gray-700/50 transition"
          data-employee-id="{{ emp.id }}"
          data-existing-periods="{{ emp.existing_payrolls|join(',') }}"
        >
          <td class="px-6 py-3 font-medium text-gray-100">{{ emp.full_name }}</td>

          <!-- Safely format numbers -->
          <td class="px-6 py-3">₱ {{ "{:,.2f}".format(emp.basic_salary | default(0)) }}</td>
          <td class="px-6 py-3">₱ {{ "{:,.2f}".format(emp.allowance | default(0)) }}</td>
          <td class="px-6 py-3 worked-days text-yellow-400">—</td>
          <td class="px-6 py-3">₱ {{ "{:,.2f}".format(emp.sss | default(0)) }}</td>
          <td class="px-6 py-3">₱ {{ "{:,.2f}".format(emp.philhealth | default(0)) }}</td>
          <td class="px-6 py-3">₱ {{ "{:,.2f}".format(emp.pagibig | default(0)) }}</td>
          <td class="px-6 py-3">₱ 0.00</td>
          <td class="px-6 py-3">₱ 0.00</td>
          <td class="px-6 py-3 font-bold text-green-600 net-pay">₱ 0.00</td>

          <td class="px-6 py-3">
            <button
              class="process-btn px-4 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white text-sm"
              onclick="previewPayroll({{ emp.id }})"
            >
              Process
            </button>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="11" class="px-6 py-4 text-center text-gray-400">
            No employees found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

</section>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const workedDaysUrl = "{{ url_for('payroll_admin.get_the_working_days_for_a_month') }}";

// Load worked days dynamically
function loadWorkedDays() {
  const select = document.getElementById("period");
  const option = select.selectedOptions[0];
  if (!option || !option.value) return;

  const start = option.dataset.start;
  const end = option.dataset.end;

  document.querySelectorAll("tr[data-employee-id]").forEach(row => {
    const empId = row.dataset.employeeId;
    const cell = row.querySelector(".worked-days");
    cell.textContent = "Loading...";

    fetch(`${workedDaysUrl}?employee_id=${empId}&start_date=${start}&end_date=${end}`)
      .then(res => res.json())
      .then(data => {
        cell.textContent = `${data.worked_days} / ${data.total_working_days}`;
      })
      .catch(() => {
        cell.textContent = "—";
      });
  });
}

// Preview payroll for employee
function previewPayroll(empId) {
  const periodId = document.getElementById("period").value;
  if (!periodId) {
    Swal.fire('Select payroll period','','warning');
    return;
  }

  const urlTemplate = "{{ url_for('payroll_admin.regular_payroll_preview', employee_id=0) }}";
  const url = urlTemplate.replace("0", empId) + "?period_id=" + periodId;
  window.location.href = url;
}
</script>
{% endblock %}
